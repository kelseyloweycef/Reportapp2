<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Report Assistant (Shared Live)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { school: { blue: '#0f172a', lightBlue: '#1e3a8a', red: '#dc2626' } }
          }
        }
      }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased">
    
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;

        // --- CONSTANTS ---
        const HPL_LEVELS = ["Collaboration/Empathy", "Agile", "Hard Working"];
        const STANDARD_LEVELS = ["Excellent", "Good", "Average", "Poor"];
        const DEFAULT_SUBJECT_DEPARTMENTS = { "IB History": "Social Studies", "IGCSE History": "Social Studies", "Year 9 History": "Social Studies" };
        const DEFAULT_COMMENT_BANK = { "IB History": { "HPL": { "Collaboration/Empathy": [], "Agile": [], "Hard Working": [] }, "Language": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Assessment": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Homework": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Improvement": { "Excellent": [], "Good": [], "Average": [], "Poor": [] } } };

        // --- ICONS ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Users = ({ className }) => <Icon className={className} path={<><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/></>} />;
        const Library = ({ className }) => <Icon className={className} path={<><path d="m16 6 4 14"/><path d="M12 6v14"/><path d="M8 8v12"/><path d="M4 4v16"/></>} />;
        const Calendar = ({ className }) => <Icon className={className} path={<><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></>} />;
        const ArrowRight = ({ className }) => <Icon className={className} path={<><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>} />;
        const ArrowLeft = ({ className }) => <Icon className={className} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />;
        const PlusCircle = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>} />;
        const Trash2 = ({ className }) => <Icon className={className} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/></>} />;
        const Camera = ({ className }) => <Icon className={className} path={<><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>} />;
        const Save = ({ className }) => <Icon className={className} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></>} />;
        const Pencil = ({ className }) => <Icon className={className} path={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/></>} />;
        const Briefcase = ({ className }) => <Icon className={className} path={<><rect width="20" height="14" x="2" y="7" rx="2" ry="2"/><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/></>} />;

        // --- UI COMPONENTS ---
        const Header = ({ isConnected, logo, onLogoUpdate }) => {
            const fileInputRef = useRef(null);
            return (
                <div className="bg-school-blue text-white pt-8 pb-16 px-6 shadow-md border-b-4 border-school-lightBlue">
                  <div className="max-w-5xl mx-auto flex items-start justify-between">
                    <div className="flex items-start gap-4">
                        <div className="bg-white p-2 rounded-lg relative group cursor-pointer" onClick={() => fileInputRef.current?.click()}>
                            <img src={logo || "https://cdn-icons-png.flaticon.com/512/3665/3665939.png"} className="h-16 w-16 object-contain" />
                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><Camera className="w-6 h-6 text-white" /></div>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => {const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=()=>onLogoUpdate(r.result); r.readAsDataURL(f);}}} />
                        </div>
                        <div><h1 className="text-3xl font-bold tracking-tight">Teacher Report Assistant</h1><div className="mt-2 text-xs font-bold">{isConnected ? <span className="text-green-300">● Live Sync Active</span> : <span className="text-red-300">○ Connecting...</span>}</div></div>
                    </div>
                  </div>
                </div>
            );
        };

        const ClassSetup = ({ subject, setSubject, subjectOptions, department, setDepartment, departments, subjectDepartments, onStartClass, onAddSubject, reportPeriod, setReportPeriod, subjectTypes }) => {
            const [namesInput, setNamesInput] = useState("");
            return (
                <div className="bg-white rounded-xl shadow-lg p-8 -mt-8 relative z-10 border-t-4 border-school-lightBlue animate-in">
                    <h2 className="text-2xl font-bold mb-6">Class Setup</h2>
                    <div className="space-y-6">
                        <div><label className="block text-sm font-bold mb-2">1. Select Department</label><select value={department} onChange={e=>setDepartment(e.target.value)} className="w-full p-3 border rounded-lg">{departments.map(d=><option key={d} value={d}>{d}</option>)}</select></div>
                        <div className={!department ? "opacity-50 pointer-events-none" : ""}>
                            <label className="block text-sm font-bold mb-2">2. Select Subject</label>
                            <select value={subject} onChange={e=>setSubject(e.target.value)} className="w-full p-3 border rounded-lg">
                                <option value="">-- Choose Subject --</option>
                                {subjectOptions.filter(s=>(subjectDepartments[s]||"Other")===department).map(s=><option key={s} value={s}>{s}</option>)}
                            </select>
                        </div>
                        <div className={!subject ? "opacity-50 pointer-events-none" : ""}>
                            <label className="block text-sm font-bold mb-2">3. Students (One per line)</label>
                            <textarea value={namesInput} onChange={e=>setNamesInput(e.target.value)} className="w-full p-3 border rounded-lg h-32" placeholder="Alice Smith&#10;Bob Jones" />
                        </div>
                        <button onClick={() => onStartClass(namesInput.split('\n').filter(n=>n.trim()), [{id:'HPL', label:'HPL'}, {id:'Language', label:'Language'}, {id:'Assessment', label:'Assessment'}])} className="w-full bg-school-red text-white py-4 rounded font-bold hover:bg-red-700 transition">Start Cycle</button>
                    </div>
                </div>
            );
        };

        const CommentCategory = ({ category, optionsMap, currentValue, onChange, levels }) => {
            const skill = "General";
            const opts = optionsMap[skill]?.[levels[0]] || [];
            return (
                <div className="p-4 bg-white rounded-xl shadow-sm border-l-4 border-school-lightBlue">
                    <div className="flex flex-wrap gap-2 mb-4">
                        {levels.map(l => <button key={l} className="px-3 py-1.5 rounded-lg text-xs font-bold border bg-white">{l}</button>)}
                    </div>
                    <select className="w-full p-2 border rounded bg-gray-50 text-sm mb-4" onChange={e=>onChange(currentValue ? currentValue + " " + e.target.value : e.target.value)}>
                        <option value="">-- Select Comment --</option>
                        {opts.map((o, i) => <option key={i} value={o}>{o}</option>)}
                    </select>
                    <textarea rows={2} value={currentValue} readOnly className="w-full p-2 border rounded bg-gray-50 text-sm italic" />
                </div>
            );
        };

        const BatchStep = ({ category, students, classData, activeCategories, onUpdateStudent }) => {
            return (
                <div className="space-y-8 animate-in pb-32">
                    <div className="bg-blue-50 border-l-4 border-school-lightBlue p-4 rounded-r-lg sticky top-0 z-20 shadow-sm"><h2 className="text-xl font-bold">Category: {category.label}</h2></div>
                    {students.map((student, idx) => (
                        <div key={student} className="bg-white rounded-xl shadow-lg border overflow-hidden">
                            <div className="bg-slate-800 px-6 py-3 text-white font-bold">{idx+1}. {student}</div>
                            
                            {/* BUILD HISTORY PREVIEW */}
                            <div className="bg-slate-50 p-4 border-b">
                                <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest mb-3">Report Draft Progress</p>
                                <div className="space-y-2">
                                    {activeCategories.map(cat => {
                                        const content = classData[student]?.[cat.id];
                                        if (!content && cat.id !== category.id) return null;
                                        return (
                                            <div key={cat.id} className={`p-3 rounded border-l-4 ${cat.id === category.id ? 'bg-blue-50 border-school-lightBlue' : 'bg-white border-gray-200'}`}>
                                                <span className="text-[9px] font-black uppercase text-gray-400">{cat.label}</span>
                                                <p className="text-xs">{content || "(Drafting...)"}</p>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>

                            <div className="p-4">
                                <CommentCategory category={category} optionsMap={{"General":{"Excellent":[]}}} currentValue={classData[student]?.[category.id] || ""} onChange={val=>onUpdateStudent(student, category.id, val)} levels={STANDARD_LEVELS} />
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ResultPanel = ({ prompt }) => (
            <div className="bg-white rounded-xl shadow-xl p-8 border animate-in">
                <h2 className="text-2xl font-bold mb-4">Complete Reports</h2>
                <textarea readOnly value={prompt} className="w-full h-96 p-4 border rounded font-mono text-sm bg-gray-50" />
            </div>
        );

        // --- MAIN APP ---
        const App = () => {
            const firebaseConfig = { apiKey: "AIzaSyBzIP_EWP8o73U6W0xfeTFVriWopjzgrCE", authDomain: "reports-shared-app.firebaseapp.com", projectId: "reports-shared-app", storageBucket: "reports-shared-app.firebasestorage.app", messagingSenderId: "158065703096", appId: "1:158065703096:web:160fc5d53253d63eea5c4d", measurementId: "G-QECHCQCZ0C" };
            if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            const SHARED_DOC_REF = db.collection('app_data').doc('master_bank');

            const [subject, setSubject] = useState("");
            const [department, setDepartment] = useState("Social Studies");
            const [students, setStudents] = useState([]);
            const [currentStep, setCurrentStep] = useState(0);
            const [classData, setClassData] = useState({});
            const [activeCats, setActiveCats] = useState([]);
            const [isConnected, setIsConnected] = useState(false);

            useEffect(() => {
                auth.signInAnonymously().catch(e=>console.error(e));
                const unsub = SHARED_DOC_REF.onSnapshot(doc => setIsConnected(true), () => setIsConnected(false));
                return () => unsub();
            }, []);

            return (
                <div className="min-h-screen bg-gray-50 pb-32">
                    <Header isConnected={isConnected} logo={null} onLogoUpdate={()=>{}} />
                    <main className="max-w-5xl mx-auto px-4">
                        {students.length === 0 ? (
                            <ClassSetup subject={subject} setSubject={setSubject} subjectOptions={["IB History", "IGCSE History"]} department={department} setDepartment={setDepartment} departments={["Social Studies", "English"]} subjectDepartments={DEFAULT_SUBJECT_DEPARTMENTS} onStartClass={(n,c)=>{setStudents(n); setActiveCats(c); setClassData(n.reduce((a,v)=>({...a,[v]:{}}),{}));}} reportPeriod="P2" setReportPeriod={()=>{}} subjectTypes={{}} />
                        ) : currentStep < activeCats.length ? (
                            <BatchStep category={activeCats[currentStep]} students={students} classData={classData} activeCategories={activeCats} onUpdateStudent={(n,c,v)=>setClassData(p=>({...p,[n]:{...p[n],[c]:v}}))} />
                        ) : (
                            <ResultPanel prompt={Object.entries(classData).map(([s,d])=>`${s}\n${Object.values(d).join('\n')}`).join('\n\n')} />
                        )}
                    </main>
                    {students.length > 0 && currentStep < activeCats.length && (
                        <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 z-50 flex justify-between max-w-5xl mx-auto shadow-2xl">
                            <button onClick={()=>setCurrentStep(currentStep-1)} className="px-6 py-2 text-gray-400 font-bold">Back</button>
                            <button onClick={()=>setCurrentStep(currentStep+1)} className="px-10 py-3 bg-school-lightBlue text-white rounded-lg font-bold">{currentStep===activeCats.length-1?"Generate":"Next Step"}</button>
                        </div>
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
