<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Teacher Report Assistant (Shared Live)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    
    <script>
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { sans: ['Inter', 'sans-serif'] },
            colors: { school: { blue: '#0f172a', lightBlue: '#1e3a8a', red: '#dc2626' } }
          }
        }
      }
    </script>
    <style>
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .animate-in { animation: fadeIn 0.5s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body class="bg-gray-50 text-slate-800 antialiased">
    <div id="root"></div>

    <script type="text/babel" data-presets="typescript,react">
        const { useState, useEffect, useRef } = React;

        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBzIP_EWP8o73U6W0xfeTFVriWopjzgrCE",
            authDomain: "reports-shared-app.firebaseapp.com",
            projectId: "reports-shared-app",
            storageBucket: "reports-shared-app.firebasestorage.app",
            messagingSenderId: "158065703096",
            appId: "1:158065703096:web:160fc5d53253d63eea5c4d",
            measurementId: "G-QECHCQCZ0C"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        auth.signInAnonymously().catch(err => console.error(err));
        const SHARED_DOC_REF = db.collection('app_data').doc('master_bank');

        // --- CONSTANTS ---
        const HPL_LEVELS = ["Collaboration/Empathy", "Agile", "Hard Working"];
        const STANDARD_LEVELS = ["Excellent", "Good", "Average", "Poor"];
        
        // --- ICONS ---
        const Icon = ({ path, className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{path}</svg>;
        const Camera = ({ className }) => <Icon className={className} path={<><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></>} />;
        const CloudCheck = ({ className }) => <Icon className={className} path={<><path d="M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 5.5-7.5"/><polyline points="8 15 12 19 16 15"/></>} />;
        const CloudOff = ({ className }) => <Icon className={className} path={<><line x1="1" y1="1" x2="23" y2="23"/><path d="M22.61 16.95A5 5 0 0 0 18 10h-1.26a8 8 0 0 0-7.05-6M5 5a8 8 0 0 0 4 7h1.8a5 5 0 0 0 .68 8.44"/></>} />;
        const Settings = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></>} />;
        const Pencil = ({ className }) => <Icon className={className} path={<><path d="M17 3a2.85 2.83 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5Z"/><path d="m15 5 4 4"/></>} />;
        const Trash2 = ({ className }) => <Icon className={className} path={<><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/></>} />;
        const PlusCircle = ({ className }) => <Icon className={className} path={<><circle cx="12" cy="12" r="10"/><path d="M8 12h8"/><path d="M12 8v8"/></>} />;
        const ArrowRight = ({ className }) => <Icon className={className} path={<><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></>} />;
        const ArrowLeft = ({ className }) => <Icon className={className} path={<><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></>} />;
        const Save = ({ className }) => <Icon className={className} path={<><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/></>} />;
        const X = ({ className }) => <Icon className={className} path={<><path d="M18 6 6 18"/><path d="m6 6 12 12"/></>} />;

        const DEFAULT_COMMENT_BANK = { "IB History": { "HPL": { "Collaboration/Empathy": [], "Agile": [], "Hard Working": [] }, "Language": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Assessment": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Homework": { "Excellent": [], "Good": [], "Average": [], "Poor": [] }, "Improvement": { "Excellent": [], "Good": [], "Average": [], "Poor": [] } } };
        const DEFAULT_SUBJECT_DEPARTMENTS = { "IB History": "Social Studies", "IGCSE History": "Social Studies", "Year 9 History": "Social Studies", "Year 9 Geography": "Social Studies" };

        const Header = ({ isConnected, logo, onLogoUpdate }) => {
            const fileInputRef = useRef(null);
            return (
                <div className="bg-school-blue text-white pt-8 pb-16 px-6 shadow-md border-b-4 border-school-lightBlue">
                  <div className="max-w-5xl mx-auto flex items-start justify-between">
                    <div className="flex items-start gap-4">
                        <div className="bg-white p-2 rounded-lg relative group cursor-pointer" onClick={() => fileInputRef.current?.click()}>
                            <img src={logo || "https://cdn-icons-png.flaticon.com/512/3665/3665939.png"} className="h-16 w-16 object-contain" />
                            <div className="absolute inset-0 bg-black/60 flex items-center justify-center opacity-0 group-hover:opacity-100 transition"><Camera className="w-6 h-6 text-white" /></div>
                            <input type="file" ref={fileInputRef} className="hidden" accept="image/*" onChange={(e) => {const f=e.target.files[0]; if(f){const r=new FileReader(); r.onload=()=>onLogoUpdate(r.result); r.readAsDataURL(f);}}} />
                        </div>
                        <div>
                            <h1 className="text-3xl font-bold tracking-tight">Teacher Report Assistant</h1>
                            <div className="mt-2">{isConnected ? <span className="text-xs bg-green-500/20 text-green-300 px-2 py-1 rounded-full font-bold border border-green-500/50">Online</span> : <span className="text-xs bg-red-500/20 text-red-300 px-2 py-1 rounded-full font-bold border border-red-500/50">Offline</span>}</div>
                        </div>
                    </div>
                  </div>
                </div>
            );
        };

        const ClassSetup = ({ subject, setSubject, subjectOptions, department, setDepartment, departments, subjectDepartments, onStartClass, onAddSubject, reportPeriod, setReportPeriod, subjectTypes, mockTitles, onUpdateMockTitle, onDeleteSubject, onDeleteDepartment, onAddDepartment }) => {
            const [namesInput, setNamesInput] = useState("");
            const [isCreating, setIsCreating] = useState(false);
            const [newName, setNewName] = useState("");
            const [newType, setNewType] = useState('full');
            const [opts, setOpts] = useState({ HPL: false, Language: false, Homework: false });

            const handleStart = () => {
                const names = namesInput.split('\n').map(s => s.trim()).filter(s => s.length > 0);
                if (names.length === 0) return alert("Enter names.");
                let cats = [];
                if (reportPeriod === "Mocks") { cats = (mockTitles || ["","","","",""]).map((t, i) => ({ id: `Mock${i+1}`, label: t.trim() || `Mock ${i+1}` })); }
                else if (subjectTypes[subject] === 'shared' || isCreating && newType === 'shared') {
                    cats.push({id: "Assessment", label: "Assessment"}, {id: "Improvement", label: "Improvement"});
                    if (opts.HPL) cats.push({id: "HPL", label: "HPL"});
                    if (opts.Language) cats.push({id: "Language", label: "Language"});
                    if (opts.Homework) cats.push({id: "Homework", label: "Homework"});
                } else { cats = [{id: "HPL", label: "HPL"}, {id: "Language", label: "Language"}, {id: "Assessment", label: "Assessment"}, {id: "Homework", label: "Homework"}, {id: "Improvement", label: "Improvement"}]; }
                onStartClass(names, cats);
            };

            return (
                <div className="bg-white rounded-xl shadow-lg p-8 -mt-8 relative z-10 border-t-4 border-school-lightBlue animate-in">
                    <h2 className="text-2xl font-bold mb-6">Class Setup</h2>
                    <div className="space-y-6">
                        <div>
                            <label className="block text-sm font-bold mb-2">1. Department</label>
                            <div className="flex gap-2">
                                <select value={department} onChange={(e) => setDepartment(e.target.value)} className="w-full p-3 border rounded-lg">
                                    <option value="">-- Select --</option>
                                    {departments.map(d => <option key={d} value={d}>{d}</option>)}
                                </select>
                                <button onClick={() => {const n=prompt("Dept:"); if(n) onAddDepartment(n.trim());}} className="p-3 bg-school-lightBlue text-white rounded-lg"><PlusCircle className="w-5 h-5"/></button>
                            </div>
                        </div>
                        <div className={!department ? "opacity-50 pointer-events-none" : ""}>
                            <label className="block text-sm font-bold mb-2">2. Subject</label>
                            {isCreating ? (
                                <div className="bg-blue-50 p-4 rounded-lg">
                                    <input value={newName} onChange={e=>setNewName(e.target.value)} className="w-full p-2 border rounded mb-2" placeholder="Subject Name" />
                                    <div className="flex gap-4 text-sm mb-4">
                                        <label><input type="radio" checked={newType==='full'} onChange={()=>setNewType('full')} /> Full</label>
                                        <label><input type="radio" checked={newType==='shared'} onChange={()=>setNewType('shared')} /> Shared</label>
                                    </div>
                                    <button onClick={()=>{onAddSubject(newName, newType, department); setIsCreating(false);}} className="bg-school-lightBlue text-white px-4 py-2 rounded">Save</button>
                                </div>
                            ) : (
                                <div className="flex gap-2">
                                    <select value={subject} onChange={e=>e.target.value==='__NEW__'?setIsCreating(true):setSubject(e.target.value)} className="w-full p-3 border rounded-lg">
                                        <option value="">-- Select --</option>
                                        {subjectOptions.filter(s=>(subjectDepartments[s]||"Other")===department).map(s=><option key={s} value={s}>{s}</option>)}
                                        <option value="__NEW__" className="text-blue-600 font-bold">+ New Subject</option>
                                    </select>
                                    {subject && <button onClick={onDeleteSubject} className="p-3 bg-red-100 text-red-600 rounded-lg"><Trash2 className="w-5 h-5"/></button>}
                                </div>
                            )}
                        </div>
                        <div className={!subject ? "opacity-50 pointer-events-none" : ""}>
                            <label className="block text-sm font-bold mb-2">3. Period</label>
                            <div className="grid grid-cols-3 gap-2">
                                {["Progress 2", "Progress 3", "Mocks"].map(p => <button key={p} onClick={()=>setReportPeriod(p)} className={`p-3 rounded-lg border-2 font-bold ${reportPeriod===p?'bg-school-lightBlue text-white border-school-lightBlue':'bg-gray-50'}`}>{p}</button>)}
                            </div>
                        </div>
                        <div className={!subject ? "opacity-50 pointer-events-none" : ""}>
                            <label className="block text-sm font-bold mb-2">4. Students (One per line)</label>
                            <textarea value={namesInput} onChange={e=>setNamesInput(e.target.value)} className="w-full p-3 border rounded-lg h-32" placeholder="Name 1&#10;Name 2" />
                        </div>
                        <button onClick={handleStart} className="w-full bg-school-red text-white font-bold py-4 rounded-lg shadow-md hover:bg-red-700 transition">Start Cycle</button>
                    </div>
                </div>
            );
        };

        const CommentCategory = ({ category, optionsMap, currentValue, onChange, onAddComment, onEditComment, onDeleteComment, levels, onAddSkill, onSwitchSkill, activeSkill, skillTabs, onDeleteSkill }) => {
            const [activeLevel, setActiveLevel] = useState(null);
            const [isAdding, setIsAdding] = useState(false);
            const [isManaging, setIsManaging] = useState(false);
            const [newComment, setNewComment] = useState("");
            const [editing, setEditing] = useState(null);
            const [editText, setEditText] = useState("");

            const supportsSkills = category.id === "Assessment" || category.id === "Improvement";
            const skill = supportsSkills ? activeSkill : "General";
            const opts = (activeLevel && optionsMap[skill]?.[activeLevel]) || [];

            return (
                <div className="p-4 bg-white rounded-xl shadow-sm border-l-4 border-school-lightBlue">
                    {supportsSkills && (
                        <div className="flex gap-2 mb-4 overflow-x-auto pb-2">
                            {skillTabs.map(s => <button key={s} onClick={()=>{onSwitchSkill(s); setActiveLevel(null);}} className={`px-3 py-1 rounded-full text-xs font-bold whitespace-nowrap ${activeSkill===s?'bg-school-blue text-white':'bg-gray-100 text-gray-600'}`}>{s}</button>)}
                            <button onClick={()=>{const n=prompt("Skill:"); if(n) onAddSkill(n.trim());}} className="text-green-600"><PlusCircle className="w-4 h-4"/></button>
                        </div>
                    )}
                    <div className="flex flex-wrap gap-2 mb-4">
                        {levels.map(l => <button key={l} onClick={()=>{setActiveLevel(l); setIsAdding(false); setIsManaging(false);}} className={`px-3 py-1.5 rounded-lg text-xs font-bold border ${activeLevel===l?'bg-school-lightBlue text-white':'bg-white'}`}>{l}</button>)}
                    </div>
                    {activeLevel && (
                        <div className="space-y-3">
                            <div className="flex justify-between items-center border-b pb-1">
                                <span className="text-[10px] font-black uppercase text-gray-400">{activeLevel} Comments</span>
                                <div className="flex gap-3">
                                    <button onClick={()=>{setIsManaging(!isManaging); setIsAdding(false);}} className="text-xs text-gray-400">Manage</button>
                                    <button onClick={()=>{setIsAdding(!isAdding); setIsManaging(false);}} className="text-xs text-school-lightBlue font-bold">+ Add</button>
                                </div>
                            </div>
                            {isAdding && (
                                <div className="flex gap-2"><input value={newComment} onChange={e=>setNewComment(e.target.value)} className="flex-1 border p-1 rounded text-sm bg-blue-50" placeholder="New comment..." autoFocus /><button onClick={()=>{onAddComment(activeLevel, newComment.trim(), skill); setNewComment(""); setIsAdding(false);}} className="bg-green-600 text-white px-2 rounded text-xs">Save</button></div>
                            )}
                            {isManaging ? (
                                <div className="max-h-32 overflow-y-auto border rounded p-2 bg-gray-50">
                                    {opts.map((o, i) => (
                                        <div key={i} className="flex justify-between items-center text-xs py-1 border-b last:border-0">
                                            {editing === o ? <><input value={editText} onChange={e=>setEditText(e.target.value)} className="flex-1 border mr-2" /><button onClick={()=>{onEditComment(activeLevel, o, editText, skill); setEditing(null);}}><Save className="w-3 h-3 text-green-600"/></button></> : <><span className="flex-1 mr-2">{o}</span><div className="flex gap-2"><button onClick={()=>{setEditing(o); setEditText(o);}}><Pencil className="w-3 h-3 text-blue-400"/></button><button onClick={()=>onDeleteComment(activeLevel, o, skill)}><Trash2 className="w-3 h-3 text-red-400"/></button></div></>}
                                        </div>
                                    ))}
                                </div>
                            ) : (
                                <select className="w-full p-2 border rounded bg-gray-50 text-sm" onChange={e=>onChange(currentValue ? currentValue + " " + e.target.value : e.target.value)} value="">
                                    <option value="" disabled>Select comment...</option>
                                    {opts.map((o, i) => <option key={i} value={o}>{o}</option>)}
                                </select>
                            )}
                        </div>
                    )}
                    <textarea rows={2} value={currentValue} readOnly className="w-full p-2 border rounded mt-3 bg-gray-50 text-sm" placeholder="Draft text..." />
                    <div className="flex justify-end mt-1"><button onClick={()=>onChange("")} className="text-[10px] text-red-400 font-bold uppercase">Clear</button></div>
                </div>
            );
        };

        const BatchStep = ({ category, students, classData, optionsMap, onUpdateStudent, onAddCustomComment, onEditComment, onDeleteComment, levels, onShareGlobal, onSharePeriod, reportPeriod, onAddSkill, skillTabs, onDeleteSkill, activeCategories }) => {
            const [activeSkills, setActiveSkills] = useState({});
            
            return (
                <div className="space-y-8 animate-in pb-32">
                    <div className="bg-blue-50 border-l-4 border-school-lightBlue p-4 rounded-r-lg flex justify-between items-center">
                        <h2 className="text-xl font-bold text-school-blue">Current: {category.label}</h2>
                        <div className="flex gap-2">
                            {category.id === 'HPL' && <button onClick={()=>onShareGlobal(category.id)} className="bg-purple-600 text-white text-[10px] font-bold px-3 py-2 rounded">Sync All Subjects</button>}
                            {(reportPeriod.includes("Progress")) && (category.id !== 'HPL') && <button onClick={()=>onSharePeriod(reportPeriod==='Progress 2'?'Progress 3':'Progress 2')} className="bg-indigo-600 text-white text-[10px] font-bold px-3 py-2 rounded">Sync to {reportPeriod==='Progress 2'?'P3':'P2'}</button>}
                        </div>
                    </div>
                    <div className="space-y-10">
                        {students.map((student, idx) => (
                            <div key={student} className="bg-white rounded-xl shadow-md border overflow-hidden">
                                <div className="bg-gray-100 px-6 py-3 border-b font-bold text-gray-700">{idx+1}. {student}</div>
                                
                                {/* LIVE HISTORY PREVIEW */}
                                <div className="bg-slate-50 p-4 border-b">
                                    <div className="flex items-center gap-2 mb-3">
                                        <div className="h-2 w-2 bg-green-500 rounded-full animate-pulse"></div>
                                        <p className="text-[10px] font-black text-slate-400 uppercase tracking-widest">Report Progress History</p>
                                    </div>
                                    <div className="space-y-2">
                                        {activeCategories.map(cat => {
                                            const content = classData[student]?.[cat.id];
                                            if (!content && cat.id !== category.id) return null;
                                            const isCurrent = cat.id === category.id;
                                            return (
                                                <div key={cat.id} className={`text-xs p-3 rounded border-l-4 transition-all ${isCurrent ? 'bg-blue-50 border-school-lightBlue shadow-sm' : 'bg-white border-gray-200'}`}>
                                                    <div className="flex justify-between items-center mb-1">
                                                        <span className={`font-black uppercase text-[9px] ${isCurrent ? 'text-school-lightBlue' : 'text-gray-400'}`}>{cat.label} {isCurrent ? '(Working...)' : ''}</span>
                                                        {!isCurrent && content && <span className="text-[9px] text-green-500 font-bold">SAVED</span>}
                                                    </div>
                                                    <p className={`${isCurrent ? 'text-school-blue font-medium' : 'text-gray-600'} italic`}>
                                                        {content || (isCurrent ? "Drafting current section..." : "")}
                                                    </p>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>

                                <div className="p-4">
                                    <CommentCategory category={category} optionsMap={optionsMap} currentValue={classData[student]?.[category.id] || ""} onChange={val=>onUpdateStudent(student, category.id, val)} onAddComment={onAddCustomComment} onEditComment={onEditComment} onDeleteComment={onDeleteComment} levels={levels} onAddSkill={onAddSkill} onDeleteSkill={onDeleteSkill} skillTabs={category.id==="Assessment"||category.id==="Improvement"?skillTabs:["General"]} activeSkill={activeSkills[student]||"General"} onSwitchSkill={s=>setActiveSkills(prev=>({...prev,[student]:s}))} />
                                </div>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const ResultPanel = ({ prompt }) => {
            const handleDownload = () => {
                const blob = new Blob(["<html><body style='font-family:Arial;'>" + prompt.replace(/\n/g, "<br>") + "</body></html>"], {type: 'application/msword'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); a.href=url; a.download="Reports.doc"; a.click();
            };
            return (
                <div className="bg-white rounded-xl shadow-xl border overflow-hidden animate-in">
                    <div className="p-4 border-b bg-gray-50 flex justify-between items-center"><span className="font-bold">Compiled Reports</span><button onClick={handleDownload} className="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold">Download .doc</button></div>
                    <textarea readOnly value={prompt} className="w-full h-96 p-6 font-mono text-sm bg-gray-50 border-none" />
                </div>
            );
        };

        const ActionPanel = ({ onBack, onNext, isLastStep }) => (
            <div className="fixed bottom-0 left-0 right-0 bg-white border-t p-4 shadow-2xl z-50">
                <div className="max-w-5xl mx-auto flex justify-between gap-4">
                    <button onClick={onBack} className="px-6 py-3 text-gray-400 font-bold flex items-center gap-2"><ArrowLeft className="w-4 h-4"/> Back</button>
                    <button onClick={onNext} className={`px-10 py-3 rounded-lg font-bold text-white shadow-lg flex items-center gap-2 ${isLastStep?'bg-green-600':'bg-school-lightBlue'}`}>
                        {isLastStep ? "Finish & Generate" : "Next Category"} <ArrowRight className="w-4 h-4"/>
                    </button>
                </div>
            </div>
        );

        const App = () => {
            const [customSubjects, setCustomSubjects] = useState([]);
            const [subjectTypes, setSubjectTypes] = useState({});
            const [mockTitles, setMockTitles] = useState({});
            const [customBank, setCustomBank] = useState({});
            const [isConnected, setIsConnected] = useState(false);
            const [sharedLogo, setSharedLogo] = useState(null);
            const [subjectDepartments, setSubjectDepartments] = useState({});
            const [departments, setDepartments] = useState(["Social Studies", "English", "Maths", "Science", "Languages", "Arts", "PE", "Technology", "Primary", "Other"]);
            const [subjectSkills, setSubjectSkills] = useState({});
            const [subject, setSubject] = useState("");
            const [department, setDepartment] = useState("");
            const [students, setStudents] = useState([]);
            const [currentStep, setCurrentStep] = useState(0);
            const [reportPeriod, setReportPeriod] = useState("Progress 2");
            const [classData, setClassData] = useState({});
            const [finalPrompt, setFinalPrompt] = useState("");
            const [activeCats, setActiveCats] = useState([]);

            useEffect(() => {
                const unsub = SHARED_DOC_REF.onSnapshot(doc => {
                    if (doc.exists) {
                        const d = doc.data();
                        setCustomSubjects(d.customSubjects || []);
                        setSubjectTypes(d.subjectTypes || {});
                        setMockTitles(d.mockTitles || {});
                        setCustomBank(d.customBank || {});
                        setSubjectDepartments(d.subjectDepartments || {});
                        setDepartments(d.departments || departments);
                        setSubjectSkills(d.subjectSkills || {});
                        setSharedLogo(d.logo);
                        setIsConnected(true);
                    } else {
                        SHARED_DOC_REF.set({ customSubjects:[], subjectTypes:{}, mockTitles:{}, customBank:{}, subjectDepartments:DEFAULT_SUBJECT_DEPARTMENTS, subjectSkills:{}, departments, logo:null });
                    }
                });
                return () => unsub();
            }, []);

            const update = (k, v) => SHARED_DOC_REF.update({ [k]: v });
            const getBankKey = (c) => (c==='HPL'||c==='Language') ? `${subject}::SHARED` : `${subject}::${reportPeriod}`;

            return (
                <div className="min-h-screen bg-gray-50 pb-32">
                    <Header isConnected={isConnected} logo={sharedLogo} onLogoUpdate={l=>update('logo', l)} />
                    <main className="max-w-5xl mx-auto px-4">
                        {students.length === 0 ? (
                            <ClassSetup subject={subject} setSubject={setSubject} subjectOptions={[...Object.keys(DEFAULT_SUBJECT_DEPARTMENTS), ...customSubjects]} department={department} setDepartment={setDepartment} departments={departments} subjectDepartments={subjectDepartments} onStartClass={(n,c)=>{setStudents(n); setActiveCats(c); setClassData(n.reduce((a,v)=>({...a,[v]:{}}),{}));}} onAddSubject={(n,t,d)=>{const uS=[...new Set([...customSubjects,n])]; update('customSubjects',uS); const uT={...subjectTypes,[n]:t}; update('subjectTypes',uT); const uD={...subjectDepartments,[n]:d}; update('subjectDepartments',uD); setSubject(n);}} reportPeriod={reportPeriod} setReportPeriod={setReportPeriod} subjectTypes={subjectTypes} mockTitles={mockTitles[subject]||["","","","",""]} onUpdateMockTitle={(i,v)=>{const m={...mockTitles}; m[subject]=m[subject]||["","","","",""]; m[subject][i]=v; update('mockTitles', m);}} onDeleteSubject={()=>update('customSubjects', customSubjects.filter(s=>s!==subject))} onDeleteDepartment={d=>update('departments', departments.filter(x=>x!==d))} onAddDepartment={d=>update('departments', [...departments, d])} />
                        ) : currentStep < activeCats.length ? (
                            <BatchStep category={activeCats[currentStep]} students={students} classData={classData} activeCategories={activeCats} optionsMap={(() => {
                                    const c = activeCats[currentStep].id;
                                    const k = getBankKey(c);
                                    const map = {};
                                    const sks = subjectSkills[subject]?.[c] || ["General"];
                                    sks.forEach(sk => {
                                        map[sk] = {};
                                        (c === 'HPL' ? HPL_LEVELS : STANDARD_LEVELS).forEach(l => {
                                            const cust = (customBank[k]?.[c]?.[l]?.[sk]) || [];
                                            const def = (sk === "General" ? DEFAULT_COMMENT_BANK[subject]?.[c]?.[l] : []) || [];
                                            map[sk][l] = [...new Set([...def, ...cust])];
                                        });
                                    });
                                    return map;
                                })()} onUpdateStudent={(n,c,v)=>setClassData(p=>({...p,[n]:{...p[n],[c]:v}}))} onAddCustomComment={(l,t,s)=>{
                                    const cId = activeCats[currentStep].id;
                                    const k = getBankKey(cId);
                                    const nB = JSON.parse(JSON.stringify(customBank));
                                    if(!nB[k]) nB[k]={}; if(!nB[k][cId]) nB[k][cId]={}; if(!nB[k][cId][l]) nB[k][cId][l]={}; if(!nB[k][cId][l][s]) nB[k][cId][l][s]=[];
                                    if(!nB[k][cId][l][s].includes(t)){ nB[k][cId][l][s].push(t); update('customBank', nB); }
                                }} onEditComment={(l,o,n,s)=>{
                                    const cId=activeCats[currentStep].id; const k=getBankKey(cId); const nB=JSON.parse(JSON.stringify(customBank));
                                    const list=nB[k]?.[cId]?.[l]?.[s]; if(list){ list[list.indexOf(o)]=n; update('customBank', nB); }
                                }} onDeleteComment={(l,t,s)=>{
                                    const cId=activeCats[currentStep].id; const k=getBankKey(cId); const nB=JSON.parse(JSON.stringify(customBank));
                                    const list=nB[k]?.[cId]?.[l]?.[s]; if(list){ nB[k][cId][l][s]=list.filter(x=>x!==t); update('customBank', nB); }
                                }} levels={activeCats[currentStep].id==='HPL'?HPL_LEVELS:STANDARD_LEVELS} onShareGlobal={()=>{const c=activeCats[currentStep].id; const sD=customBank[`${subject}::SHARED`]?.[c]; const nB={...customBank}; customSubjects.forEach(t=>{if(t!==subject){const k=`${t}::SHARED`; nB[k]=nB[k]||{}; nB[k][c]=sD;}}); update('customBank', nB);}} onSharePeriod={tp=>{const c=activeCats[currentStep].id; const nB={...customBank}; nB[`${subject}::${tp}`]=nB[`${subject}::${tp}`]||{}; nB[`${subject}::${tp}`][c]=customBank[`${subject}::${reportPeriod}`][c]; update('customBank', nB);}} reportPeriod={reportPeriod} onAddSkill={s=>{const sk={...subjectSkills}; sk[subject]=sk[subject]||{}; const c=activeCats[currentStep].id; sk[subject][c]=[...(sk[subject][c]||["General"]), s]; update('subjectSkills', sk);}} skillTabs={subjectSkills[subject]?.[activeCats[currentStep].id] || ["General"]} />
                        ) : (
                            <ResultPanel prompt={finalPrompt} />
                        )}
                    </main>
                    {students.length > 0 && currentStep < activeCats.length && (
                        <ActionPanel onBack={()=>setCurrentStep(currentStep-1)} onNext={()=>{if(currentStep===activeCats.length-1){
                            let o=""; students.forEach(s=>{o+=s.toUpperCase()+"\n"; activeCats.forEach(c=>{if(classData[s]?.[c.id])o+=`â€¢ ${classData[s][c.id].trim()}\n`;});o+="\n----------------\n\n";}); setFinalPrompt(o);
                        } setCurrentStep(currentStep+1); window.scrollTo(0,0);}} isLastStep={currentStep===activeCats.length-1} />
                    )}
                </div>
            );
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
